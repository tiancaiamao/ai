# Working Memory: LLM è‡ªä¸»ä¸Šä¸‹æ–‡ç®¡ç†

## Feature Overview

å°† Agent çš„ä¸Šä¸‹æ–‡ç®¡ç†æƒä»è§„åˆ™é©±åŠ¨è½¬å˜ä¸º LLM è‡ªä¸»ç®¡ç†ã€‚LLM é€šè¿‡ tool æ“ä½œ Working Memory æ–‡ä»¶ï¼Œè‡ªå·±å†³å®šè®°ä½ä»€ä¹ˆã€ä¸¢å¼ƒä»€ä¹ˆï¼Œå®ç°ä» Level 0.5 åˆ° Level 3 çš„è·¨è¶Šã€‚

### èƒŒæ™¯æ¼”è¿›æ¨¡å‹

```
Level 0: çº¿æ€§å¯¹è¯ + å‹ç¼©ï¼ˆå¤§å¤šæ•°ç®€å• agentï¼‰
         - Token è¶…é™è§¦å‘å‹ç¼©
         - å·¥å…·è¾“å‡º summary
         - ä¿ç•™æœ€è¿‘ k è½®
         
Level 1: Plan ç»“æ„ï¼ˆç„¦ç‚¹æ§åˆ¶ï¼‰
         - è§£å†³ attention drift
         - ä½†ä¸å¤„ç†å†å²å‹ç¼©
         
Level 2: Working State Objectï¼ˆæ˜¾å¼ä»»åŠ¡çŠ¶æ€ï¼‰
         - çŠ¶æ€ä»å¯¹è¯ä¸­æŠ½ç¦»
         - å¯¹è¯å¯ä»¥è¢«ä¸¢å¼ƒ
         
Level 3: Memory Policy Learningï¼ˆLLM è‡ªä¸»å†³ç­–ï¼‰
         - LLM å†³å®šä»€ä¹ˆæ—¶å€™å‹ç¼©
         - LLM å†³å®šè®°ä½ä»€ä¹ˆ/ä¸¢å¼ƒä»€ä¹ˆ
         - LLM è‡ªå·±ç®¡ç†ä¸Šä¸‹æ–‡
```

**å½“å‰ç³»ç»Ÿï¼šLevel 0.5**ï¼ˆæœ‰ compaction ä½†æ²¡æœ‰æ˜¾å¼çŠ¶æ€ï¼‰
**ç›®æ ‡ï¼šLevel 3**ï¼ˆLLM å®Œå…¨è‡ªä¸»ç®¡ç† memory policyï¼‰

### æ ¸å¿ƒç†å¿µ

```
ä¼ ç»Ÿ Agentï¼šè§„åˆ™å†³å®šå‹ç¼© â†’ LLM è¢«åŠ¨æ¥å—
æœ¬è®¾è®¡ï¼šLLM è‡ªä¸»å†³ç­– â†’ LLM ä¸»åŠ¨ç®¡ç† â†’ é—­ç¯æ§åˆ¶

æˆç†Ÿç³»ç»Ÿï¼šç”¨ç»“æ„åŒ–çŠ¶æ€æ›¿ä»£å†å²å¯¹è¯
ä¼ ç»Ÿç³»ç»Ÿï¼šç”¨å†å²å¯¹è¯æ‰¿è½½ç»“æ„
```

### å…³é”®å˜åŒ–

| ç»´åº¦ | ä»¥å‰ | ç°åœ¨ |
|------|------|------|
| ä¸Šä¸‹æ–‡æ¥æº | chat history summary | working memory æ–‡ä»¶ |
| å‹ç¼©ç­–ç•¥ | Agent è§„åˆ™è§¦å‘ï¼ˆ75% tokenï¼‰ | LLM è‡ªå·±å†³å®š |
| å†å²ç®¡ç† | å¢é‡ compaction | LLM è‡ªå·±ç»´æŠ¤ memory.md |
| Tool è¾“å‡º | è‡ªåŠ¨æˆªæ–­/summary | LLM è‡ªå·±å†³å®šä¿ç•™ä»€ä¹ˆ |
| çŠ¶æ€å­˜å‚¨ | éšå¼åœ¨ Messages ä¸­ | æ˜¾å¼åœ¨ working-memory/ |

---

## User Stories

### P1 - æ ¸å¿ƒåŠŸèƒ½ï¼ˆMVPï¼‰

**US-1: Session ç›®å½•ç»“æ„æ”¹é€ **
> As System, I want session ä»å•æ–‡ä»¶å˜ä¸ºç›®å½•ç»“æ„ï¼Œä»¥ä¾¿å®¹çº³ working memoryã€‚

**Acceptance Criteria:**
- æ–° session åˆ›å»ºæ—¶ï¼Œåˆ›å»ºç›®å½•ç»“æ„ï¼š
  ```
  ~/.ai/sessions/--<cwd>--/
  â””â”€â”€ <session-id>/
      â”œâ”€â”€ messages.jsonl
      â”œâ”€â”€ meta.json
      â””â”€â”€ working-memory/
          â”œâ”€â”€ overview.md
          â””â”€â”€ detail/
  ```
- Session åˆ‡æ¢æ—¶æ­£ç¡®è¯†åˆ«ç›®å½•ç»“æ„

**US-2: Working Memory è‡ªåŠ¨æ³¨å…¥**
> As LLM, I want æˆ‘çš„ working memory è‡ªåŠ¨åŠ è½½åˆ° prompt ä¸­ï¼Œä»¥ä¾¿æˆ‘çœ‹åˆ°è‡ªå·±ä¸Šæ¬¡å†™çš„å†…å®¹ã€‚

**Acceptance Criteria:**
- æ¯æ¬¡è¯·æ±‚æ—¶è¯»å– `working-memory/overview.md` æ³¨å…¥ prompt
- æ³¨å…¥ä½ç½®ï¼šsystem prompt ä¹‹åï¼Œrecent messages ä¹‹å‰
- æ–‡ä»¶ä¸å­˜åœ¨æ—¶åˆ›å»ºå¹¶æ³¨å…¥é»˜è®¤æ¨¡æ¿
- ä¸ç ´åç°æœ‰ prompt cache æœºåˆ¶
- history strip é‡‡ç”¨ä¸¤é˜¶æ®µç­–ç•¥ï¼š
  - `overview.md` å°šæœªè¢«æœ‰æ•ˆç»´æŠ¤æ—¶ï¼Œä¿ç•™ history æ³¨å…¥ï¼ˆé¿å…ä¸Šä¸‹æ–‡ä¸¢å¤±ï¼‰
  - ç¡®è®¤ `overview.md` å·²æœ‰æœ‰æ•ˆå†…å®¹åï¼Œå†åˆ‡æ¢åˆ°åªä¿ç•™ active turn

**US-3: ä¸Šä¸‹æ–‡å…ƒä¿¡æ¯è‡ªåŠ¨æ³¨å…¥**
> As LLM, I want æ¯æ¬¡è¯·æ±‚æ—¶è‡ªåŠ¨çœ‹åˆ°ä¸Šä¸‹æ–‡çŠ¶æ€ï¼ˆtoken ä½¿ç”¨é‡ç­‰ï¼‰ï¼Œä»¥ä¾¿æˆ‘å†³å®šä½•æ—¶å‹ç¼©/æ›´æ–° memoryã€‚

**Acceptance Criteria:**
- æ¯æ¬¡è¯·æ±‚è‡ªåŠ¨æ³¨å…¥ `context_meta` åˆ°æ¶ˆæ¯æœ«å°¾
- æ ¼å¼ï¼š
  ```json
  <context_meta>
  {
    "tokens_used": 45000,
    "tokens_max": 128000,
    "tokens_percent": 35,
    "messages_in_history": 42,
    "working_memory_size": 2400
  }
  
  ğŸ’¡ Remember to update your working-memory/overview.md to track progress and compress context if needed.
  </context_meta>
  ```
- æ³¨å…¥ä½ç½®ï¼šæ¶ˆæ¯æœ«å°¾ï¼ˆä¸ç ´å prompt cacheï¼‰
- ä¸æ¶ˆè€—é¢å¤–å¯¹è¯è½®æ¬¡

**US-4: è‡ªä¸»å‹ç¼©ç­–ç•¥ï¼ˆLevel 3ï¼‰**
> As LLM, I want å®Œå…¨è‡ªä¸»ç®¡ç†æ‰€æœ‰ä¸Šä¸‹æ–‡å‹ç¼©ï¼ŒåŒ…æ‹¬å¯¹è¯å†å²å’Œå·¥å…·è¾“å‡ºã€‚

**è®¾è®¡ç†å¿µï¼š**
- **ç§»é™¤æ‰€æœ‰è‡ªåŠ¨å‹ç¼©è§¦å‘**ï¼ˆcompact 75%ã€tool summary cutoffï¼‰
- LLM é€šè¿‡ `compact_history` tool å®Œå…¨æ§åˆ¶å‹ç¼©
- å‹ç¼©ç­–ç•¥å†™åœ¨ System Prompt ä¸­ä½œä¸ºæŒ‡å—
- 75% compaction ä¿ç•™ä½œä¸º**æœ€åå…œåº•**ï¼ˆç†æƒ³æƒ…å†µä¸‹ä¸åº”è§¦å‘ï¼‰

**å‹ç¼©ç›®æ ‡ï¼š**
1. **å¯¹è¯å†å²**ï¼šæ€»ç»“å·²å®Œæˆä»»åŠ¡ã€å½’æ¡£è¯¦ç»†è®¨è®º
2. **å·¥å…·è¾“å‡º**ï¼šå·¥å…·ç»“æœå¾€å¾€å¾ˆå¤§ï¼Œå‡ è½®åä»·å€¼é™ä½ï¼Œéœ€è¦å‹ç¼©

**å‹ç¼©ç­–ç•¥æŒ‡å—ï¼ˆLLM å‚è€ƒï¼‰ï¼š**
```
Token ä½¿ç”¨é‡    å»ºè®®æ“ä½œ
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
< 20%          æ­£å¸¸å·¥ä½œï¼Œæ— éœ€å‹ç¼©
20% - 40%      è½»åº¦å‹ç¼©ï¼šæ€»ç»“å·²å®Œæˆä»»åŠ¡ï¼Œç§»é™¤å†—ä½™å·¥å…·è¾“å‡º
40% - 60%      ä¸­åº¦å‹ç¼©ï¼šå½’æ¡£è¯¦ç»†è®¨è®ºåˆ° detail/ï¼Œå‹ç¼©æ—§å·¥å…·ç»“æœ
60% - 75%      é‡åº¦å‹ç¼©ï¼šåªä¿ç•™å…³é”®å†³ç­–å’Œå½“å‰ä»»åŠ¡
> 75%          ç³»ç»Ÿä¼šè‡ªåŠ¨è§¦å‘å…œåº•å‹ç¼©ï¼ˆä½ åº”è¯¥åœ¨æ­¤ä¹‹å‰ä¸»åŠ¨å‹ç¼©ï¼‰

ä¿ç•™è§„åˆ™ï¼š
- æœ€è¿‘ 3-5 æ¡å¯¹è¯è®°å½•å§‹ç»ˆä¿ç•™
- å½“å‰ä»»åŠ¡çŠ¶æ€å¿…é¡»ä¿ç•™
- å…³é”®å†³ç­–å¿…é¡»ä¿ç•™
- æœ€è¿‘çš„å·¥å…·è¾“å‡ºå¯ä»¥ä¿ç•™ï¼ˆè§†æƒ…å†µï¼‰
```

**Acceptance Criteria:**
- [ ] æä¾› `compact_history` toolï¼ˆæ”¯æŒå¯¹è¯å†å²å’Œå·¥å…·è¾“å‡ºå‹ç¼©ï¼‰
- [ ] ç§»é™¤è‡ªåŠ¨ tool summary è§¦å‘ï¼ˆToolCallCutoff æœºåˆ¶ï¼‰
- [ ] System Prompt åŒ…å«å®Œæ•´å‹ç¼©ç­–ç•¥æŒ‡å—
- [ ] LLM èƒ½å¤Ÿè‡ªä¸»å†³å®šå‹ç¼©æ—¶æœºå’Œç›®æ ‡
- [ ] 75% compaction å…œåº•æœºåˆ¶ä¿ç•™æœ‰æ•ˆ

**US-4: LLM è‡ªä¸»æ›´æ–° Working Memory**
> As LLM, I want ç”¨ write tool æ›´æ–°æˆ‘çš„ working memoryï¼Œä»¥ä¾¿æˆ‘æ§åˆ¶è‡ªå·±çœ‹åˆ°çš„å†…å®¹ã€‚

**Acceptance Criteria:**
- LLM å¯ä»¥ç”¨ç°æœ‰ `write` tool æ›´æ–° `working-memory/overview.md`
- LLM å¯ä»¥ç”¨ç°æœ‰ `write` tool åœ¨ `working-memory/detail/` åˆ›å»ºæ–‡ä»¶
- æ›´æ–°ç«‹å³ç”Ÿæ•ˆï¼ˆä¸‹æ¬¡è¯·æ±‚å¯è§ï¼‰
- System prompt ä¸­è¯´æ˜ Working Memory çš„èƒ½åŠ›å’Œè´£ä»»

**US-5: æ–° Session ç©ºæ¨¡æ¿**
> As LLM, I want æ–° session æ—¶çœ‹åˆ°ç©ºæ¨¡æ¿ï¼Œä»¥ä¾¿æˆ‘çŸ¥é“å¦‚ä½•å¡«å†™ working memoryã€‚

**Acceptance Criteria:**
- æ–° session åˆ›å»ºæ—¶ï¼Œ`overview.md` åŒ…å«å¼•å¯¼æ¨¡æ¿
- æ¨¡æ¿åŒ…å«ç»“æ„åŒ–æ§½ä½å’Œæ³¨é‡Šè¯´æ˜

### P2 - å¢å¼ºåŠŸèƒ½

**US-6: è¯¦ç»†å†…å®¹åˆ†å±‚å­˜å‚¨**
> As LLM, I want å°†è¯¦ç»†å†…å®¹å­˜å…¥ `detail/` ç›®å½•ï¼Œä»¥ä¾¿ä¿æŒ overview.md ç²¾ç®€ã€‚

**Acceptance Criteria:**
- LLM å¯ä»¥ `write working-memory/detail/xxx.md` ä¿å­˜è¯¦æƒ…
- LLM å¯ä»¥ `read working-memory/detail/xxx.md` è¯»å–è¯¦æƒ…
- detail/ å†…å®¹ä¸è‡ªåŠ¨æ³¨å…¥ prompt

**US-7: å†å²å½’æ¡£**
> As LLM, I want å°†å®Œæˆçš„ä»»åŠ¡å½’æ¡£ï¼Œä»¥ä¾¿æ¸…ç†å½“å‰å·¥ä½œè®°å¿†ã€‚

**Acceptance Criteria:**
- LLM å¯ä»¥åˆ›å»º `working-memory/archive/` ç›®å½•
- archive å†…å®¹ä¸æ³¨å…¥ prompt

### P3 - æœªæ¥æ‰©å±•

**US-8: è¯¦ç»†å½’æ¡£ç­–ç•¥**
> As LLM, I want æ›´æ™ºèƒ½çš„å½’æ¡£å»ºè®®ï¼Œä»¥ä¾¿ç³»ç»Ÿæç¤ºæˆ‘ä½•æ—¶åº”è¯¥å½’æ¡£ã€‚

**Acceptance Criteria:**
- å½“ context_meta æ˜¾ç¤º token > 50% æ—¶ï¼Œæé†’æ›´å¼ºçƒˆ
- å¯é€‰ï¼šè‡ªåŠ¨å»ºè®®å½’æ¡£å“ªäº›å†…å®¹

---

## Technical Context

### ç°æœ‰æ¶æ„

```
~/.ai/sessions/--<cwd>--/
â”œâ”€â”€ <session-id>.jsonl        # æ¶ˆæ¯å†å²ï¼ˆå•æ–‡ä»¶ï¼‰
â”œâ”€â”€ <session-id>.meta.json    # å…ƒæ•°æ®
â””â”€â”€ ...

pkg/session/
â”œâ”€â”€ session.go                # Session ç»“æ„
â”œâ”€â”€ manager.go                # Session ç®¡ç†
â””â”€â”€ lazy.go                   # å»¶è¿ŸåŠ è½½

pkg/prompt/builder.go         # Prompt æ„å»º
pkg/compact/compact.go        # å‹ç¼©é€»è¾‘ï¼ˆä¿ç•™ï¼Œé»˜è®¤å¯ç”¨ï¼‰
```

### ç›®æ ‡æ¶æ„

```
~/.ai/sessions/--<cwd>--/
â””â”€â”€ <session-id>/             # âœ¨ Session å˜æˆç›®å½•
    â”œâ”€â”€ messages.jsonl        # æ¶ˆæ¯å†å²ï¼ˆä¿ç•™ï¼Œä¸å†æ³¨å…¥ promptï¼‰
    â”œâ”€â”€ meta.json             # å…ƒæ•°æ®
    â””â”€â”€ working-memory/       # âœ¨ æ–°å¢
        â”œâ”€â”€ overview.md       # L1: æ³¨å…¥ prompt
        â””â”€â”€ detail/           # L2: æŒ‰éœ€è¯»å–
```

### æ¶ˆæ¯ç»“æ„å˜åŒ–

```
ä»¥å‰ï¼š
system prompt / tools / skills / AGENTS.md / history summary / recent messages

ç°åœ¨ï¼š
system prompt / tools / skills / AGENTS.md / working memory / (history or active-turn messages)
```

---

## Working Memory æ¨¡æ¿

### overview.md æ¨¡æ¿

```markdown
# Working Memory

<!--
è¿™æ˜¯ä½ çš„å¤–éƒ¨è®°å¿†ã€‚æ¯æ¬¡è¯·æ±‚æ—¶ï¼Œè¿™ä¸ªæ–‡ä»¶çš„å†…å®¹ä¼šè¢«åŠ è½½åˆ°ä½ çš„ prompt ä¸­ã€‚
ä½ è‡ªå·±å†³å®šè®°ä½ä»€ä¹ˆã€ä¸¢å¼ƒä»€ä¹ˆã€‚

ä½ çš„ context æ˜¯æœ‰é™çš„ã€‚ä½ éœ€è¦è‡ªå·±å†³å®šï¼š
- ä»€ä¹ˆæ—¶å€™å‹ç¼©
- è®°ä½ä»€ä¹ˆä¿¡æ¯
- ä¸¢å¼ƒä»€ä¹ˆå†å²

ä½¿ç”¨ write tool æ›´æ–°æ­¤æ–‡ä»¶ï¼šworking-memory/overview.md
ä¸‹æ¬¡è¯·æ±‚æ—¶ï¼Œä½ ä¼šçœ‹åˆ°è‡ªå·±å†™çš„å†…å®¹ã€‚

è¿™æ˜¯ YOUR memoryã€‚ä½ æ§åˆ¶ä½ çœ‹åˆ°çš„å†…å®¹ã€‚
-->

## å½“å‰ä»»åŠ¡
<!-- ç”¨æˆ·è®©ä½ åšä»€ä¹ˆï¼Ÿå½“å‰è¿›åº¦ï¼Ÿ -->


## å…³é”®å†³ç­–
<!-- ä½ åšè¿‡ä»€ä¹ˆé‡è¦å†³å®šï¼Ÿä¸ºä»€ä¹ˆï¼Ÿ -->


## å·²çŸ¥ä¿¡æ¯
<!-- é¡¹ç›®ç»“æ„ã€æŠ€æœ¯æ ˆã€å…³é”®æ–‡ä»¶ç­‰ -->


## å¾…è§£å†³
<!-- å¾…å¤„ç†çš„é—®é¢˜æˆ–é˜»å¡é¡¹ -->


## æœ€è¿‘æ“ä½œ
<!-- æœ€è¿‘å‡ æ­¥åšäº†ä»€ä¹ˆï¼ˆå¯é€‰ï¼Œç”¨äºå¿«é€Ÿå›é¡¾ï¼‰ -->


<!--
æç¤ºï¼š
- æŸ¥çœ‹ context_metaï¼ˆæ¯æ¬¡è‡ªåŠ¨æ³¨å…¥ï¼‰äº†è§£ token ä½¿ç”¨æƒ…å†µ
- éœ€è¦ä¿å­˜è¯¦ç»†å†…å®¹æ—¶ï¼Œå†™å…¥ working-memory/detail/ ç›®å½•
- æ–‡ä»¶è·¯å¾„ç›¸å¯¹äº session ç›®å½•
-->
```

---

## Success Criteria

1. **åŠŸèƒ½å®Œæ•´æ€§**
   - [ ] Session ç›®å½•ç»“æ„æ­£ç¡®åˆ›å»º
   - [ ] working-memory/overview.md è‡ªåŠ¨æ³¨å…¥åˆ° prompt
   - [ ] ä»…åœ¨ working memory å·²ç¡®è®¤ç»´æŠ¤åæ‰ strip history
   - [ ] context_meta è‡ªåŠ¨æ³¨å…¥åˆ°æ¶ˆæ¯æœ«å°¾
   - [ ] LLM å¯ä»¥ç”¨ write/read æ“ä½œ memory æ–‡ä»¶
   - [ ] æ–° session åˆ›å»ºç©ºæ¨¡æ¿

2. **æ€§èƒ½**
   - [ ] æ³¨å…¥ overview.md ä¸å¢åŠ æ˜æ˜¾å»¶è¿Ÿ (< 10ms)
   - [ ] æ–‡ä»¶è¯»å†™æ•ˆç‡åˆç†ï¼ˆoverview.md < 5KBï¼‰

3. **LLM å¯ç†è§£æ€§**
   - [ ] System prompt æ¸…æ™°è¯´æ˜ Working Memory èƒ½åŠ›
   - [ ] æ¨¡æ¿å¼•å¯¼ LLM å¦‚ä½•ä½¿ç”¨
   - [ ] LLM èƒ½å¤Ÿè‡ªä¸»æ›´æ–° memoryï¼ˆéœ€å®æµ‹éªŒè¯ï¼‰

4. **ç³»ç»Ÿç¨³å®šæ€§**
   - [ ] ç°æœ‰ compaction é€»è¾‘ä¿ç•™ï¼ˆé»˜è®¤å¯ç”¨ï¼‰
   - [ ] å¦‚æœ LLM ç®¡ç†å¾—å½“ï¼Œcompaction ä¸åº”é¢‘ç¹è§¦å‘

---

## Out of Scope

- L0 (abstract.md) åˆ†å±‚ï¼ˆæœªæ¥å¯æ‰©å±•ï¼‰
- è‡ªåŠ¨ä» messages.jsonl ç”Ÿæˆ working memoryï¼ˆLLM è‡ªå·±å†³å®šï¼‰
- å¤š session é—´çš„ memory å…±äº«
- Memory ç‰ˆæœ¬æ§åˆ¶
- æ—§ session è‡ªåŠ¨è¿ç§»
